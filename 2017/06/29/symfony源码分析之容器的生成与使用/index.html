
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="代码狗">
    <title>symfony源码分析之容器的生成与使用 - 代码狗</title>
    <meta name="author" content="fantiq">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fantiq","sameAs":["https://github.com/fantiq"],"image":"avatar.jpg"},"articleBody":"symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\\Component\\HttpKernel\\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var/cache/[ENV]/appProjectContainer中。\n其中很多是框架自己的依赖关系，这些依赖关系类似java的方式，通过xml文件的形式进行声明，这些xml存在与框架的代码中，Syfmony\\Bundle\\FrameworkBundle\\Resource\\config\\*.xml。\n\n0. 代码流程容器相关的代码大致如下流程\n123456789101112131415161718192021222324252627282930313233# Symfony\\Component\\HttpKernel\\Kernelprotected function initializeContainer()&#123;\t// 获取生成的容器代码文件 类名    $class = $this-&gt;getContainerClass();    $cache = new ConfigCache($this-&gt;getCacheDir().&#x27;/&#x27;.$class.&#x27;.php&#x27;, $this-&gt;debug);    $fresh = true;    // 检查是否需要重新生成 容器 缓存类    if (!$cache-&gt;isFresh()) &#123;    \t// .....        try &#123;            $container = null;            // 重新生成容器缓存类            // 实例化生成容器缓存代码的类            $container = $this-&gt;buildContainer();            // 调用方法开始生成容器代码            $container-&gt;compile();        &#125; finally &#123;        \t// ......        &#125;        // 将生成的代码写入文件        $this-&gt;dumpContainer($cache, $container, $class, $this-&gt;getContainerBaseClass());        $fresh = false;    &#125;    //加载生成的容器文件 实例化容器类 并且复制给 Kernel::$container    require_once $cache-&gt;getPath();    $this-&gt;container = new $class();    $this-&gt;container-&gt;set(&#x27;kernel&#x27;, $this);    // ......&#125;\n\n下面着重分析 容器代码生成类的创建过程\n123456789101112131415161718192021protected function buildContainer()&#123;\t// 创建容器缓存代码的目录    $container = $this-&gt;getContainerBuilder();    $container-&gt;addObjectResource($this);    // 容器预处理，在开始编译容器前，会给容器添加一些 pass (这个问题就是在2017phpcon大会上提过的，当时没解决，这里看代码解决了)    // 这些pass主要处理框架配置中声明的容器关系    $this-&gt;prepareContainer($container);    // 解析容器配置文件 我们自己注入容器的类就要声明在配置文件 app/config/services.yml 中    // 这里就是对这个配置文件进行解析，并将其中的关系生成代码到容器中    if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;        $container-&gt;merge($cont);    &#125;    $container-&gt;addCompilerPass(new AddAnnotatedClassesToCachePass($this));    $container-&gt;addResource(new EnvParametersResource(&#x27;SYMFONY__&#x27;));    return $container;&#125;\n\n如上的分析可以将容器代码生成的过程精简到如下3个步骤\n12345678910111213141516171819202122232425# Symfony\\Component\\HttpKernel\\Kernelprotected function initializeContainer()&#123;\t// ...    try &#123;        $container = null;        $container = $this-&gt;buildContainer();        3. 编译生成容器代码        $container-&gt;compile();    &#125; finally &#123;    \t// ......    &#125;    // ......&#125;protected function buildContainer()&#123;\t// 1. 实例化创建容器代码类的时候，预处理一些内容    $this-&gt;prepareContainer($container);    // 2. 加载项目容器的配置文件进行处理 app/config/services.yml    if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;        $container-&gt;merge($cont);    &#125;&#125;\n\n\n1. 容器预处理12345678910111213141516171819202122232425262728# Symfony\\Component\\HttpKernel\\Kernelprotected function prepareContainer(ContainerBuilder $container)&#123;    $extensions = array();    // 这里的 bundles 是在 initializeBundles 方法中实例化AppKernel中注册的Bundles 进行的赋值    foreach ($this-&gt;bundles as $bundle) &#123;    \t// 这里将注册的Bundle进行循环处理    \t// 取出bundle的extension 并 注册到 container中        if ($extension = $bundle-&gt;getContainerExtension()) &#123;            $container-&gt;registerExtension($extension);            $extensions[] = $extension-&gt;getAlias();        &#125;        if ($this-&gt;debug) &#123;            $container-&gt;addObjectResource($bundle);        &#125;    &#125;    foreach ($this-&gt;bundles as $bundle) &#123;    \t// 触发bundle的build方法        $bundle-&gt;build($container);    &#125;    $this-&gt;build($container);    // 这里的代码是为了确定将 MergeExtensionConfigurationPass 这个Pass类添加到容器的Pass中    $container-&gt;getCompilerPassConfig()-&gt;setMergePass(new MergeExtensionConfigurationPass($extensions));&#125;\n\n我们可以在 AppKernel::registerBundles 中查看到注册的 Bundles \n123456789101112131415public function registerBundles()&#123;    $bundles = [        new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),        new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),        new Symfony\\Bundle\\TwigBundle\\TwigBundle(),        new Symfony\\Bundle\\MonologBundle\\MonologBundle(),        new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),        new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),        new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),        new AppBundle\\AppBundle(),    ];    return $bundles;&#125;\n我们以 Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle 作为目标进行代码的继续跟踪\n12$extension = $bundle-&gt;getContainerExtension();$container-&gt;registerExtension($extension);\n跟中方法 getContainerExtension , 在类 FrameworkBundle 所继承的类Syfmony\\Component\\HttpKernel\\Bundle\\Bundle中找到\n1234567891011121314151617181920212223242526# Syfmony\\Component\\HttpKernel\\Bundle\\Bundlepublic function getContainerExtension()&#123;    if (null === $this-&gt;extension) &#123;    \t// 获取extension        $extension = $this-&gt;createContainerExtension();        if (null !== $extension) &#123;            // check naming convention            $basename = preg_replace(&#x27;/Bundle$/&#x27;, &#x27;&#x27;, $this-&gt;getName());            $expectedAlias = Container::underscore($basename);            if ($expectedAlias != $extension-&gt;getAlias()) &#123;                throw new \\LogicException(......);            &#125;            $this-&gt;extension = $extension;        &#125; else &#123;            $this-&gt;extension = false;        &#125;    &#125;    if ($this-&gt;extension) &#123;        return $this-&gt;extension;    &#125;&#125;\n\n以下是获取extension的代码逻辑\n123456789101112131415161718192021222324252627282930313233343536373839404142434445protected function createContainerExtension()&#123;\t// 这里实例化一个类并返回    if (class_exists($class = $this-&gt;getContainerExtensionClass())) &#123;        return new $class();    &#125;&#125;protected function getContainerExtensionClass()&#123;\t// 类名的规则\t// 命名空间\\DependencyInjection\\(将类名的Bundle替换成Extension)    $basename = preg_replace(&#x27;/Bundle$/&#x27;, &#x27;&#x27;, $this-&gt;getName());    return $this-&gt;getNamespace().&#x27;\\\\DependencyInjection\\\\&#x27;.$basename.&#x27;Extension&#x27;;&#125;# 以下两个方法主要还是当 $this-&gt;namespace $this-&gt;name 不存在的时候# 通过方法 $this-&gt;parseClassName() 来解析出来public function getNamespace()&#123;    if (null === $this-&gt;namespace) &#123;        $this-&gt;parseClassName();    &#125;    return $this-&gt;namespace;&#125;final public function getName()&#123;    if (null === $this-&gt;name) &#123;        $this-&gt;parseClassName();    &#125;    return $this-&gt;name;&#125;private function parseClassName()&#123;\t# 命名空间 类型的截取    $pos = strrpos(static::class, &#x27;\\\\&#x27;);\t// 截取类的命名空间    $this-&gt;namespace = false === $pos ? &#x27;&#x27; : substr(static::class, 0, $pos);    if (null === $this-&gt;name) &#123;\t\t// 截取类的名称        $this-&gt;name = false === $pos ? static::class : substr(static::class, $pos + 1);    &#125;&#125;\n以上代码解析出来的就是 Symfony\\Bundle\\FrameworkBundle\\DependencyInjection\\FrameworkExtension。回到代码中\n1234if ($extension = $bundle-&gt;getContainerExtension()) &#123;    $container-&gt;registerExtension($extension);    $extensions[] = $extension-&gt;getAlias();&#125;\n要执行容器的registerExtension方法 \n1234567891011# Symfony\\Component\\DependencyInjection\\ContainerBuilderpublic function registerExtension(ExtensionInterface $extension)&#123;\t// $extension-&gt;getAlias() 这个方法在 Symfony\\Component\\DependencyInjection\\Extension\\Extension 中\t// 主要的作用是将类名取出 将类名的Excention后缀去掉    $this-&gt;extensions[$extension-&gt;getAlias()] = $extension;    if (false !== $extension-&gt;getNamespace()) &#123;        $this-&gt;extensionsByNs[$extension-&gt;getNamespace()] = $extension;    &#125;&#125;\n\n2. 解析容器配置文件解析容器配置文件的代码\n123if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;    $container-&gt;merge($cont);&#125;\n主要是执行了方法 registerContainerConfiguration 这个方法在 AppKernel 类中\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118# AppKernelpublic function registerContainerConfiguration(LoaderInterface $loader)&#123;\t// 这里的配置文件是 app/config/config_[ENV].yml 是Yml格式的文件\t// 这里的loader 应该是类 `YamlFileLoader`    $loader-&gt;load($this-&gt;getRootDir().&#x27;/config/config_&#x27;.$this-&gt;getEnvironment().&#x27;.yml&#x27;);&#125;# 所以这里的代码应该是执行 # SymfonyComponent\\DependencyInjection\\Loader\\YamlFileLoader::loadpublic function load($resource, $type = null)&#123;\t// 加载配置文件，将yml格式的配置内容解析成php数组    $content = $this-&gt;loadFile($path);    $this-&gt;container-&gt;fileExists($path);    // ......    // 处理配置文件中的 key `imports`  对import 声明的文件进行load处理    $this-&gt;parseImports($content, $path);    // 处理配置文件中的参数部分    if (isset($content[&#x27;parameters&#x27;])) &#123;        if (!is_array($content[&#x27;parameters&#x27;])) &#123;            throw new InvalidArgumentException(sprintf(&#x27;The &quot;parameters&quot; key should contain an array in %s. Check your YAML syntax.&#x27;, $resource));        &#125;        foreach ($content[&#x27;parameters&#x27;] as $key =&gt; $value) &#123;            $this-&gt;container-&gt;setParameter($key, $this-&gt;resolveServices($value, $resource, true));        &#125;    &#125;    // extensions    $this-&gt;loadFromExtensions($content);    // services    $this-&gt;anonymousServicesCount = 0;    $this-&gt;setCurrentDir(dirname($path));    try &#123;    \t// 这里将services中的声明封装到Definition 将Definition 存储到Container中        $this-&gt;parseDefinitions($content, $resource);    &#125; finally &#123;        $this-&gt;instanceof = array();    &#125;&#125;private function parseDefinitions(array $content, $file)&#123;\t// 如果配置文件中不存在key services 这里直接返回    if (!isset($content[&#x27;services&#x27;])) &#123;        return;    &#125;    // ......    // 这里处理 配置文件中 services 下的 _default 配置信息，处理后会删除这个key    $defaults = $this-&gt;parseDefaults($content, $file);    //对配置文件中定义的services进行逐个分析    foreach ($content[&#x27;services&#x27;] as $id =&gt; $service) &#123;        $this-&gt;parseDefinition($id, $service, $file, $defaults);    &#125;&#125;private function parseDefinition($id, $service, $file, array $defaults)&#123;    //实例化 definition    if ($this-&gt;isLoadingInstanceof) &#123;        $definition = new ChildDefinition(&#x27;&#x27;);    &#125; elseif (isset($service[&#x27;parent&#x27;])) &#123;    \t// ......        $definition = new ChildDefinition($service[&#x27;parent&#x27;]);    &#125; else &#123;        $definition = new Definition();        // ......    &#125;    // 这里的大段逻辑是处理一些services相关的配置信息    if (isset($service[&#x27;class&#x27;])) &#123;        $definition-&gt;setClass($service[&#x27;class&#x27;]);    &#125;    // ......    if (array_key_exists(&#x27;resource&#x27;, $service)) &#123;        if (!is_string($service[&#x27;resource&#x27;])) &#123;            throw new InvalidArgumentException(sprintf(&#x27;A &quot;resource&quot; attribute must be of type string for service &quot;%s&quot; in %s. Check your YAML syntax.&#x27;, $id, $file));        &#125;        $exclude = isset($service[&#x27;exclude&#x27;]) ? $service[&#x27;exclude&#x27;] : null;        // 如果service的配置中存在key resource 进行类的注册        $this-&gt;registerClasses($definition, $id, $service[&#x27;resource&#x27;], $exclude);    &#125; else &#123;        $this-&gt;setDefinition($id, $definition);    &#125;&#125;# Symfony\\Component\\DependencyInjection\\Loader\\FileLoaderpublic function registerClasses(Definition $prototype, $namespace, $resource, $exclude = null)&#123;\t// 一些判断\t// ......\t// 这里主要是处理 存在 resource 这个key的services注册\t// symfony的容器会将指定目录下都所有类都会注册到container\t// 这里的 findClasses 就是查询类的过程    $classes = $this-&gt;findClasses($namespace, $resource, $exclude);    // prepare for deep cloning    $prototype = serialize($prototype);    foreach ($classes as $class) &#123;    \t// 这里调用 setDefinition 对resource下的类全部设置到 container中        $this-&gt;setDefinition($class, unserialize($prototype));    &#125;&#125;protected function setDefinition($id, Definition $definition)&#123;\t// ......     //将definition添加到 container 里面    $this-&gt;container-&gt;setDefinition($id, $definition instanceof ChildDefinition ? $definition : $definition-&gt;setInstanceofConditionals($this-&gt;instanceof));&#125;\n\n这里着重分析下 registerClasses方法中的 $this-&gt;findClasses\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263# Symfony\\Component\\DependencyInjection\\Loader\\FileLoaderprivate function findClasses($namespace, $pattern, $excludePattern)&#123;    // ......    // 这里是对文件的处理    foreach ($this-&gt;glob($pattern, true, $resource) as $path =&gt; $info) &#123;    \t// ......        if (!$r-&gt;isInterface() &amp;&amp; !$r-&gt;isTrait() &amp;&amp; !$r-&gt;isAbstract()) &#123;            $classes[] = $class;        &#125;    &#125;    // ......    return $classes;&#125;# Symfony\\Component\\Config\\Loader\\FileLoaderprotected function glob($pattern, $recursive, &amp;$resource = null, $ignoreErrors = false)&#123;    try &#123;        $prefix = $this-&gt;locator-&gt;locate($prefix, $this-&gt;currentDir, true);    &#125; catch (FileLocatorFileNotFoundException $e) &#123;    \t// ......    &#125;    // 这里返回的是 yield    $resource = new GlobResource($prefix, $pattern, $recursive);    // 所以这里需要foreach来触发    foreach ($resource as $path =&gt; $info) &#123;        yield $path =&gt; $info;    &#125;&#125;# Symfony\\Component\\Config\\Resource\\GlobResourcepublic function getIterator()&#123;    if (false === strpos($this-&gt;pattern, &#x27;/**/&#x27;) &amp;&amp; (defined(&#x27;GLOB_BRACE&#x27;) || false === strpos($this-&gt;pattern, &#x27;&#123;&#x27;))) &#123;        foreach (glob($this-&gt;prefix.$this-&gt;pattern, defined(&#x27;GLOB_BRACE&#x27;) ? GLOB_BRACE : 0) as $path) &#123;            if ($this-&gt;recursive &amp;&amp; is_dir($path)) &#123;            \t// 这里是读取文件的主要逻辑            \t// 使用的是 php 中提供的处理文件的迭代器                $files = iterator_to_array(new \\RecursiveIteratorIterator(                    new \\RecursiveCallbackFilterIterator(                        new \\RecursiveDirectoryIterator($path, \\FilesystemIterator::SKIP_DOTS | \\FilesystemIterator::FOLLOW_SYMLINKS),                        function (\\SplFileInfo $file) &#123; return &#x27;.&#x27; !== $file-&gt;getBasename()[0]; &#125;                    ),                    \\RecursiveIteratorIterator::LEAVES_ONLY                ));            &#125; elseif (is_file($path)) &#123;                yield $path =&gt; new \\SplFileInfo($path);            &#125;            // ......        &#125;        return;    &#125;    $finder = new Finder();    // ......    foreach ($finder-&gt;followLinks()-&gt;sortByName()-&gt;in($this-&gt;prefix) as $path =&gt; $info) &#123;        if (preg_match($regex, substr($path, $prefixLen)) &amp;&amp; $info-&gt;isFile()) &#123;            yield $path =&gt; $info;        &#125;    &#125;&#125;\n\n3. 编译生成容器代码这段代码主要是执行 Pass代码 这里主要跟踪下 MergeExtensionConfigurationPass 这个Pass，他执行了 FrameworkExtension::load ，这个方法中加载了框架需要的各种类以及依赖关系\n123456789101112131415161718192021222324252627282930313233343536373839404142# Symfony\\Component\\DependencyInjection\\Complier\\Complier public function compile(ContainerBuilder $container)&#123;    try &#123;    \t// 这里触发了所有Passs的 process方法        foreach ($this-&gt;passConfig-&gt;getPasses() as $pass) &#123;            $pass-&gt;process($container);        &#125;    &#125; catch (\\Exception $e) &#123;    \t// ......    &#125;&#125;# Symfony\\Component\\HttpKernel\\DependencyInjection\\MergeExtensionConfigurationPasspublic function process(ContainerBuilder $container)&#123;\t// ......    parent::process($container);&#125;# Symfony\\Component\\DependencyInjection\\Compiler\\MergeExtensionConfigurationPasspublic function process(ContainerBuilder $container)&#123;    foreach ($container-&gt;getExtensions() as $name =&gt; $extension) &#123;    \t// ......    \t// 执行了 extension 的 load 方法        $extension-&gt;load($config, $tmpContainer);        // ......    &#125;    $container-&gt;addDefinitions($definitions);    $container-&gt;addAliases($aliases);&#125;# Symfony\\Bundle\\FrameworkBundle\\DependencyInjection\\FrameworkExtensionpublic function load(array $configs, ContainerBuilder $container)&#123;\t/*\t这个方法中的代码很多，主要内容是加载了很多的 xml 配置文件 \t这些配置文件的作用是声明框架所需要的类之间的关系\t */&#125;\n","dateCreated":"2017-06-29T20:50:36+08:00","dateModified":"2017-06-30T20:43:30+08:00","datePublished":"2017-06-29T20:50:36+08:00","description":"symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\\Component\\HttpKernel\\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var/cache/[ENV]/appProjectContainer中。\n其中很多是框架自己的依赖关系，这些依赖关系类似java的方式，通过xml文件的形式进行声明，这些xml存在与框架的代码中，Syfmony\\Bundle\\FrameworkBundle\\Resource\\config\\*.xml。","headline":"symfony源码分析之容器的生成与使用","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"},"publisher":{"@type":"Organization","name":"fantiq","sameAs":["https://github.com/fantiq"],"image":"avatar.jpg","logo":{"@type":"ImageObject","url":"avatar.jpg"}},"url":"https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/","keywords":"symfony, php框架, 源码分析"}</script>
    <meta name="description" content="symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\Component\HttpKernel\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var&#x2F;cache&#x2F;[ENV]&#x2F;appProjectContainer中。">
<meta property="og:type" content="blog">
<meta property="og:title" content="symfony源码分析之容器的生成与使用">
<meta property="og:url" content="https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="代码狗">
<meta property="og:description" content="symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\Component\HttpKernel\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var&#x2F;cache&#x2F;[ENV]&#x2F;appProjectContainer中。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-06-29T12:50:36.000Z">
<meta property="article:modified_time" content="2017-06-30T12:43:30.000Z">
<meta property="article:author" content="fantiq">
<meta property="article:tag" content="symfony">
<meta property="article:tag" content="php框架">
<meta property="article:tag" content="源码分析">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://fantiq.github.io/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-bo1h1ya3kmjmd94f0k5yc43ngmshulfcyc8apgyrr2pfx48g1zk5lyp9do8g.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            代码狗
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">fantiq</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/fantiq"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            symfony源码分析之容器的生成与使用
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2017-06-29T20:50:36+08:00">
	
		    6月 29, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">symfony源码分析</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>symfony 的容器是有一个编译过程的，框架初始化的时候会执行 <code>Symfony\Component\HttpKernel\Kernel::initializationContainer</code>，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件<code>var/cache/[ENV]/appProjectContainer</code>中。</p>
<p>其中很多是框架自己的依赖关系，这些依赖关系类似java的方式，通过xml文件的形式进行声明，这些xml存在与框架的代码中，<code>Syfmony\Bundle\FrameworkBundle\Resource\config\*.xml</code>。</p>
<span id="more"></span>
<h2 id="0-代码流程"><a href="#0-代码流程" class="headerlink" title="0. 代码流程"></a>0. 代码流程</h2><p>容器相关的代码大致如下流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\HttpKernel\Kernel</span><br><span class="line">protected function initializeContainer()</span><br><span class="line">&#123;</span><br><span class="line">	// 获取生成的容器代码文件 类名</span><br><span class="line">    $class = $this-&gt;getContainerClass();</span><br><span class="line">    $cache = new ConfigCache($this-&gt;getCacheDir().&#x27;/&#x27;.$class.&#x27;.php&#x27;, $this-&gt;debug);</span><br><span class="line">    $fresh = true;</span><br><span class="line">    // 检查是否需要重新生成 容器 缓存类</span><br><span class="line">    if (!$cache-&gt;isFresh()) &#123;</span><br><span class="line">    	// .....</span><br><span class="line">        try &#123;</span><br><span class="line">            $container = null;</span><br><span class="line">            // 重新生成容器缓存类</span><br><span class="line">            // 实例化生成容器缓存代码的类</span><br><span class="line">            $container = $this-&gt;buildContainer();</span><br><span class="line">            // 调用方法开始生成容器代码</span><br><span class="line">            $container-&gt;compile();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">        	// ......</span><br><span class="line">        &#125;</span><br><span class="line">        // 将生成的代码写入文件</span><br><span class="line">        $this-&gt;dumpContainer($cache, $container, $class, $this-&gt;getContainerBaseClass());</span><br><span class="line"></span><br><span class="line">        $fresh = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //加载生成的容器文件 实例化容器类 并且复制给 Kernel::$container</span><br><span class="line">    require_once $cache-&gt;getPath();</span><br><span class="line">    $this-&gt;container = new $class();</span><br><span class="line">    $this-&gt;container-&gt;set(&#x27;kernel&#x27;, $this);</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面着重分析 容器代码生成类的创建过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected function buildContainer()</span><br><span class="line">&#123;</span><br><span class="line">	// 创建容器缓存代码的目录</span><br><span class="line"></span><br><span class="line">    $container = $this-&gt;getContainerBuilder();</span><br><span class="line">    $container-&gt;addObjectResource($this);</span><br><span class="line">    // 容器预处理，在开始编译容器前，会给容器添加一些 pass (这个问题就是在2017phpcon大会上提过的，当时没解决，这里看代码解决了)</span><br><span class="line">    // 这些pass主要处理框架配置中声明的容器关系</span><br><span class="line"></span><br><span class="line">    $this-&gt;prepareContainer($container);</span><br><span class="line"></span><br><span class="line">    // 解析容器配置文件 我们自己注入容器的类就要声明在配置文件 app/config/services.yml 中</span><br><span class="line">    // 这里就是对这个配置文件进行解析，并将其中的关系生成代码到容器中</span><br><span class="line">    if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">        $container-&gt;merge($cont);</span><br><span class="line">    &#125;</span><br><span class="line">    $container-&gt;addCompilerPass(new AddAnnotatedClassesToCachePass($this));</span><br><span class="line">    $container-&gt;addResource(new EnvParametersResource(&#x27;SYMFONY__&#x27;));</span><br><span class="line"></span><br><span class="line">    return $container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上的分析可以将容器代码生成的过程精简到如下3个步骤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\HttpKernel\Kernel</span><br><span class="line">protected function initializeContainer()</span><br><span class="line">&#123;</span><br><span class="line">	// ...</span><br><span class="line">    try &#123;</span><br><span class="line">        $container = null;</span><br><span class="line">        $container = $this-&gt;buildContainer();</span><br><span class="line">        3. 编译生成容器代码</span><br><span class="line">        $container-&gt;compile();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">    	// ......</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected function buildContainer()</span><br><span class="line">&#123;</span><br><span class="line">	// 1. 实例化创建容器代码类的时候，预处理一些内容</span><br><span class="line">    $this-&gt;prepareContainer($container);</span><br><span class="line">    // 2. 加载项目容器的配置文件进行处理 app/config/services.yml</span><br><span class="line">    if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">        $container-&gt;merge($cont);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="1-容器预处理"><a href="#1-容器预处理" class="headerlink" title="1. 容器预处理"></a>1. 容器预处理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\HttpKernel\Kernel</span><br><span class="line">protected function prepareContainer(ContainerBuilder $container)</span><br><span class="line">&#123;</span><br><span class="line">    $extensions = array();</span><br><span class="line">    // 这里的 bundles 是在 initializeBundles 方法中实例化AppKernel中注册的Bundles 进行的赋值</span><br><span class="line">    foreach ($this-&gt;bundles as $bundle) &#123;</span><br><span class="line">    	// 这里将注册的Bundle进行循环处理</span><br><span class="line">    	// 取出bundle的extension 并 注册到 container中</span><br><span class="line">        if ($extension = $bundle-&gt;getContainerExtension()) &#123;</span><br><span class="line">            $container-&gt;registerExtension($extension);</span><br><span class="line">            $extensions[] = $extension-&gt;getAlias();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($this-&gt;debug) &#123;</span><br><span class="line">            $container-&gt;addObjectResource($bundle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach ($this-&gt;bundles as $bundle) &#123;</span><br><span class="line">    	// 触发bundle的build方法</span><br><span class="line">        $bundle-&gt;build($container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;build($container);</span><br><span class="line"></span><br><span class="line">    // 这里的代码是为了确定将 MergeExtensionConfigurationPass 这个Pass类添加到容器的Pass中</span><br><span class="line">    $container-&gt;getCompilerPassConfig()-&gt;setMergePass(new MergeExtensionConfigurationPass($extensions));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在 <code>AppKernel::registerBundles</code> 中查看到注册的 Bundles </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function registerBundles()</span><br><span class="line">&#123;</span><br><span class="line">    $bundles = [</span><br><span class="line">        new Symfony\Bundle\FrameworkBundle\FrameworkBundle(),</span><br><span class="line">        new Symfony\Bundle\SecurityBundle\SecurityBundle(),</span><br><span class="line">        new Symfony\Bundle\TwigBundle\TwigBundle(),</span><br><span class="line">        new Symfony\Bundle\MonologBundle\MonologBundle(),</span><br><span class="line">        new Symfony\Bundle\SwiftmailerBundle\SwiftmailerBundle(),</span><br><span class="line">        new Doctrine\Bundle\DoctrineBundle\DoctrineBundle(),</span><br><span class="line">        new Sensio\Bundle\FrameworkExtraBundle\SensioFrameworkExtraBundle(),</span><br><span class="line">        new AppBundle\AppBundle(),</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    return $bundles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以 <code>Symfony\Bundle\FrameworkBundle\FrameworkBundle</code> 作为目标进行代码的继续跟踪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$extension = $bundle-&gt;getContainerExtension();</span><br><span class="line">$container-&gt;registerExtension($extension);</span><br></pre></td></tr></table></figure>
<p>跟中方法 <code>getContainerExtension</code> , 在类 <code>FrameworkBundle</code> 所继承的类<code>Syfmony\Component\HttpKernel\Bundle\Bundle</code>中找到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Syfmony\Component\HttpKernel\Bundle\Bundle</span><br><span class="line">public function getContainerExtension()</span><br><span class="line">&#123;</span><br><span class="line">    if (null === $this-&gt;extension) &#123;</span><br><span class="line">    	// 获取extension</span><br><span class="line">        $extension = $this-&gt;createContainerExtension();</span><br><span class="line"></span><br><span class="line">        if (null !== $extension) &#123;</span><br><span class="line"></span><br><span class="line">            // check naming convention</span><br><span class="line">            $basename = preg_replace(&#x27;/Bundle$/&#x27;, &#x27;&#x27;, $this-&gt;getName());</span><br><span class="line">            $expectedAlias = Container::underscore($basename);</span><br><span class="line">            if ($expectedAlias != $extension-&gt;getAlias()) &#123;</span><br><span class="line">                throw new \LogicException(......);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $this-&gt;extension = $extension;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;extension = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($this-&gt;extension) &#123;</span><br><span class="line">        return $this-&gt;extension;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是获取extension的代码逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">protected function createContainerExtension()</span><br><span class="line">&#123;</span><br><span class="line">	// 这里实例化一个类并返回</span><br><span class="line">    if (class_exists($class = $this-&gt;getContainerExtensionClass())) &#123;</span><br><span class="line">        return new $class();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">protected function getContainerExtensionClass()</span><br><span class="line">&#123;</span><br><span class="line">	// 类名的规则</span><br><span class="line">	// 命名空间\DependencyInjection\(将类名的Bundle替换成Extension)</span><br><span class="line">    $basename = preg_replace(&#x27;/Bundle$/&#x27;, &#x27;&#x27;, $this-&gt;getName());</span><br><span class="line"></span><br><span class="line">    return $this-&gt;getNamespace().&#x27;\\DependencyInjection\\&#x27;.$basename.&#x27;Extension&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 以下两个方法主要还是当 $this-&gt;namespace $this-&gt;name 不存在的时候</span><br><span class="line"># 通过方法 $this-&gt;parseClassName() 来解析出来</span><br><span class="line">public function getNamespace()</span><br><span class="line">&#123;</span><br><span class="line">    if (null === $this-&gt;namespace) &#123;</span><br><span class="line">        $this-&gt;parseClassName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;namespace;</span><br><span class="line">&#125;</span><br><span class="line">final public function getName()</span><br><span class="line">&#123;</span><br><span class="line">    if (null === $this-&gt;name) &#123;</span><br><span class="line">        $this-&gt;parseClassName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;name;</span><br><span class="line">&#125;</span><br><span class="line">private function parseClassName()</span><br><span class="line">&#123;</span><br><span class="line">	# 命名空间 类型的截取</span><br><span class="line">    $pos = strrpos(static::class, &#x27;\\&#x27;);</span><br><span class="line">	// 截取类的命名空间</span><br><span class="line">    $this-&gt;namespace = false === $pos ? &#x27;&#x27; : substr(static::class, 0, $pos);</span><br><span class="line">    if (null === $this-&gt;name) &#123;</span><br><span class="line">		// 截取类的名称</span><br><span class="line">        $this-&gt;name = false === $pos ? static::class : substr(static::class, $pos + 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码解析出来的就是 <code>Symfony\Bundle\FrameworkBundle\DependencyInjection\FrameworkExtension</code>。回到代码中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if ($extension = $bundle-&gt;getContainerExtension()) &#123;</span><br><span class="line">    $container-&gt;registerExtension($extension);</span><br><span class="line">    $extensions[] = $extension-&gt;getAlias();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要执行容器的<code>registerExtension</code>方法 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\DependencyInjection\ContainerBuilder</span><br><span class="line">public function registerExtension(ExtensionInterface $extension)</span><br><span class="line">&#123;</span><br><span class="line">	// $extension-&gt;getAlias() 这个方法在 Symfony\Component\DependencyInjection\Extension\Extension 中</span><br><span class="line">	// 主要的作用是将类名取出 将类名的Excention后缀去掉</span><br><span class="line">    $this-&gt;extensions[$extension-&gt;getAlias()] = $extension;</span><br><span class="line"></span><br><span class="line">    if (false !== $extension-&gt;getNamespace()) &#123;</span><br><span class="line">        $this-&gt;extensionsByNs[$extension-&gt;getNamespace()] = $extension;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-解析容器配置文件"><a href="#2-解析容器配置文件" class="headerlink" title="2. 解析容器配置文件"></a>2. 解析容器配置文件</h2><p>解析容器配置文件的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (null !== $cont = $this-&gt;registerContainerConfiguration($this-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">    $container-&gt;merge($cont);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是执行了方法 <code>registerContainerConfiguration</code> 这个方法在 <code>AppKernel</code> 类中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"># AppKernel</span><br><span class="line">public function registerContainerConfiguration(LoaderInterface $loader)</span><br><span class="line">&#123;</span><br><span class="line">	// 这里的配置文件是 app/config/config_[ENV].yml 是Yml格式的文件</span><br><span class="line">	// 这里的loader 应该是类 `YamlFileLoader`</span><br><span class="line">    $loader-&gt;load($this-&gt;getRootDir().&#x27;/config/config_&#x27;.$this-&gt;getEnvironment().&#x27;.yml&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 所以这里的代码应该是执行 </span><br><span class="line"># SymfonyComponent\DependencyInjection\Loader\YamlFileLoader::load</span><br><span class="line">public function load($resource, $type = null)</span><br><span class="line">&#123;</span><br><span class="line">	// 加载配置文件，将yml格式的配置内容解析成php数组</span><br><span class="line">    $content = $this-&gt;loadFile($path);</span><br><span class="line">    $this-&gt;container-&gt;fileExists($path);</span><br><span class="line">    // ......</span><br><span class="line">    // 处理配置文件中的 key `imports`  对import 声明的文件进行load处理</span><br><span class="line">    $this-&gt;parseImports($content, $path);</span><br><span class="line"></span><br><span class="line">    // 处理配置文件中的参数部分</span><br><span class="line">    if (isset($content[&#x27;parameters&#x27;])) &#123;</span><br><span class="line">        if (!is_array($content[&#x27;parameters&#x27;])) &#123;</span><br><span class="line">            throw new InvalidArgumentException(sprintf(&#x27;The &quot;parameters&quot; key should contain an array in %s. Check your YAML syntax.&#x27;, $resource));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ($content[&#x27;parameters&#x27;] as $key =&gt; $value) &#123;</span><br><span class="line">            $this-&gt;container-&gt;setParameter($key, $this-&gt;resolveServices($value, $resource, true));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // extensions</span><br><span class="line">    $this-&gt;loadFromExtensions($content);</span><br><span class="line"></span><br><span class="line">    // services</span><br><span class="line">    $this-&gt;anonymousServicesCount = 0;</span><br><span class="line">    $this-&gt;setCurrentDir(dirname($path));</span><br><span class="line">    try &#123;</span><br><span class="line">    	// 这里将services中的声明封装到Definition 将Definition 存储到Container中</span><br><span class="line">        $this-&gt;parseDefinitions($content, $resource);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        $this-&gt;instanceof = array();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private function parseDefinitions(array $content, $file)</span><br><span class="line">&#123;</span><br><span class="line">	// 如果配置文件中不存在key services 这里直接返回</span><br><span class="line">    if (!isset($content[&#x27;services&#x27;])) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ......</span><br><span class="line">    // 这里处理 配置文件中 services 下的 _default 配置信息，处理后会删除这个key</span><br><span class="line">    $defaults = $this-&gt;parseDefaults($content, $file);</span><br><span class="line"></span><br><span class="line">    //对配置文件中定义的services进行逐个分析</span><br><span class="line">    foreach ($content[&#x27;services&#x27;] as $id =&gt; $service) &#123;</span><br><span class="line">        $this-&gt;parseDefinition($id, $service, $file, $defaults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private function parseDefinition($id, $service, $file, array $defaults)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    //实例化 definition</span><br><span class="line">    if ($this-&gt;isLoadingInstanceof) &#123;</span><br><span class="line">        $definition = new ChildDefinition(&#x27;&#x27;);</span><br><span class="line">    &#125; elseif (isset($service[&#x27;parent&#x27;])) &#123;</span><br><span class="line">    	// ......</span><br><span class="line">        $definition = new ChildDefinition($service[&#x27;parent&#x27;]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $definition = new Definition();</span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 这里的大段逻辑是处理一些services相关的配置信息</span><br><span class="line">    if (isset($service[&#x27;class&#x27;])) &#123;</span><br><span class="line">        $definition-&gt;setClass($service[&#x27;class&#x27;]);</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    if (array_key_exists(&#x27;resource&#x27;, $service)) &#123;</span><br><span class="line">        if (!is_string($service[&#x27;resource&#x27;])) &#123;</span><br><span class="line">            throw new InvalidArgumentException(sprintf(&#x27;A &quot;resource&quot; attribute must be of type string for service &quot;%s&quot; in %s. Check your YAML syntax.&#x27;, $id, $file));</span><br><span class="line">        &#125;</span><br><span class="line">        $exclude = isset($service[&#x27;exclude&#x27;]) ? $service[&#x27;exclude&#x27;] : null;</span><br><span class="line">        // 如果service的配置中存在key resource 进行类的注册</span><br><span class="line">        $this-&gt;registerClasses($definition, $id, $service[&#x27;resource&#x27;], $exclude);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $this-&gt;setDefinition($id, $definition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Symfony\Component\DependencyInjection\Loader\FileLoader</span><br><span class="line">public function registerClasses(Definition $prototype, $namespace, $resource, $exclude = null)</span><br><span class="line">&#123;</span><br><span class="line">	// 一些判断</span><br><span class="line">	// ......</span><br><span class="line"></span><br><span class="line">	// 这里主要是处理 存在 resource 这个key的services注册</span><br><span class="line">	// symfony的容器会将指定目录下都所有类都会注册到container</span><br><span class="line">	// 这里的 findClasses 就是查询类的过程</span><br><span class="line">    $classes = $this-&gt;findClasses($namespace, $resource, $exclude);</span><br><span class="line">    // prepare for deep cloning</span><br><span class="line">    $prototype = serialize($prototype);</span><br><span class="line"></span><br><span class="line">    foreach ($classes as $class) &#123;</span><br><span class="line">    	// 这里调用 setDefinition 对resource下的类全部设置到 container中</span><br><span class="line">        $this-&gt;setDefinition($class, unserialize($prototype));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">protected function setDefinition($id, Definition $definition)</span><br><span class="line">&#123;</span><br><span class="line">	// ...... </span><br><span class="line"></span><br><span class="line">    //将definition添加到 container 里面</span><br><span class="line">    $this-&gt;container-&gt;setDefinition($id, $definition instanceof ChildDefinition ? $definition : $definition-&gt;setInstanceofConditionals($this-&gt;instanceof));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里着重分析下 registerClasses方法中的 <code>$this-&gt;findClasses</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\DependencyInjection\Loader\FileLoader</span><br><span class="line">private function findClasses($namespace, $pattern, $excludePattern)</span><br><span class="line">&#123;</span><br><span class="line">    // ......</span><br><span class="line">    // 这里是对文件的处理</span><br><span class="line">    foreach ($this-&gt;glob($pattern, true, $resource) as $path =&gt; $info) &#123;</span><br><span class="line">    	// ......</span><br><span class="line">        if (!$r-&gt;isInterface() &amp;&amp; !$r-&gt;isTrait() &amp;&amp; !$r-&gt;isAbstract()) &#123;</span><br><span class="line">            $classes[] = $class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line"></span><br><span class="line">    return $classes;</span><br><span class="line">&#125;</span><br><span class="line"># Symfony\Component\Config\Loader\FileLoader</span><br><span class="line">protected function glob($pattern, $recursive, &amp;$resource = null, $ignoreErrors = false)</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        $prefix = $this-&gt;locator-&gt;locate($prefix, $this-&gt;currentDir, true);</span><br><span class="line">    &#125; catch (FileLocatorFileNotFoundException $e) &#123;</span><br><span class="line">    	// ......</span><br><span class="line">    &#125;</span><br><span class="line">    // 这里返回的是 yield</span><br><span class="line">    $resource = new GlobResource($prefix, $pattern, $recursive);</span><br><span class="line">    // 所以这里需要foreach来触发</span><br><span class="line">    foreach ($resource as $path =&gt; $info) &#123;</span><br><span class="line">        yield $path =&gt; $info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Symfony\Component\Config\Resource\GlobResource</span><br><span class="line">public function getIterator()</span><br><span class="line">&#123;</span><br><span class="line">    if (false === strpos($this-&gt;pattern, &#x27;/**/&#x27;) &amp;&amp; (defined(&#x27;GLOB_BRACE&#x27;) || false === strpos($this-&gt;pattern, &#x27;&#123;&#x27;))) &#123;</span><br><span class="line">        foreach (glob($this-&gt;prefix.$this-&gt;pattern, defined(&#x27;GLOB_BRACE&#x27;) ? GLOB_BRACE : 0) as $path) &#123;</span><br><span class="line">            if ($this-&gt;recursive &amp;&amp; is_dir($path)) &#123;</span><br><span class="line">            	// 这里是读取文件的主要逻辑</span><br><span class="line">            	// 使用的是 php 中提供的处理文件的迭代器</span><br><span class="line">                $files = iterator_to_array(new \RecursiveIteratorIterator(</span><br><span class="line">                    new \RecursiveCallbackFilterIterator(</span><br><span class="line">                        new \RecursiveDirectoryIterator($path, \FilesystemIterator::SKIP_DOTS | \FilesystemIterator::FOLLOW_SYMLINKS),</span><br><span class="line">                        function (\SplFileInfo $file) &#123; return &#x27;.&#x27; !== $file-&gt;getBasename()[0]; &#125;</span><br><span class="line">                    ),</span><br><span class="line">                    \RecursiveIteratorIterator::LEAVES_ONLY</span><br><span class="line">                ));</span><br><span class="line">            &#125; elseif (is_file($path)) &#123;</span><br><span class="line">                yield $path =&gt; new \SplFileInfo($path);</span><br><span class="line">            &#125;</span><br><span class="line">            // ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $finder = new Finder();</span><br><span class="line">    // ......</span><br><span class="line">    foreach ($finder-&gt;followLinks()-&gt;sortByName()-&gt;in($this-&gt;prefix) as $path =&gt; $info) &#123;</span><br><span class="line">        if (preg_match($regex, substr($path, $prefixLen)) &amp;&amp; $info-&gt;isFile()) &#123;</span><br><span class="line">            yield $path =&gt; $info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-编译生成容器代码"><a href="#3-编译生成容器代码" class="headerlink" title="3. 编译生成容器代码"></a>3. 编译生成容器代码</h2><p>这段代码主要是执行 Pass代码 这里主要跟踪下 <code>MergeExtensionConfigurationPass</code> 这个Pass，他执行了 <code>FrameworkExtension::load</code> ，这个方法中加载了框架需要的各种类以及依赖关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># Symfony\Component\DependencyInjection\Complier\Complier</span><br><span class="line"> public function compile(ContainerBuilder $container)</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">    	// 这里触发了所有Passs的 process方法</span><br><span class="line">        foreach ($this-&gt;passConfig-&gt;getPasses() as $pass) &#123;</span><br><span class="line">            $pass-&gt;process($container);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (\Exception $e) &#123;</span><br><span class="line">    	// ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Symfony\Component\HttpKernel\DependencyInjection\MergeExtensionConfigurationPass</span><br><span class="line">public function process(ContainerBuilder $container)</span><br><span class="line">&#123;</span><br><span class="line">	// ......</span><br><span class="line">    parent::process($container);</span><br><span class="line">&#125;</span><br><span class="line"># Symfony\Component\DependencyInjection\Compiler\MergeExtensionConfigurationPass</span><br><span class="line">public function process(ContainerBuilder $container)</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($container-&gt;getExtensions() as $name =&gt; $extension) &#123;</span><br><span class="line">    	// ......</span><br><span class="line">    	// 执行了 extension 的 load 方法</span><br><span class="line">        $extension-&gt;load($config, $tmpContainer);</span><br><span class="line">        // ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $container-&gt;addDefinitions($definitions);</span><br><span class="line">    $container-&gt;addAliases($aliases);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Symfony\Bundle\FrameworkBundle\DependencyInjection\FrameworkExtension</span><br><span class="line">public function load(array $configs, ContainerBuilder $container)</span><br><span class="line">&#123;</span><br><span class="line">	/*</span><br><span class="line">	这个方法中的代码很多，主要内容是加载了很多的 xml 配置文件 </span><br><span class="line">	这些配置文件的作用是声明框架所需要的类之间的关系</span><br><span class="line"></span><br><span class="line">	 */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/php%E6%A1%86%E6%9E%B6/" rel="tag">php框架</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/symfony/" rel="tag">symfony</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E8%B7%AF%E7%94%B1%E7%9A%84%E7%94%9F%E6%88%90/"
                    data-tooltip="symfony源码分析之路由的生成"
                    aria-label="上一篇: symfony源码分析之路由的生成"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E6%A1%86%E6%9E%B6%E4%B8%BB%E6%B5%81%E7%A8%8B/"
                    data-tooltip="symfony源码分析之框架主流程"
                    aria-label="下一篇: symfony源码分析之框架主流程"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2021 fantiq. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E8%B7%AF%E7%94%B1%E7%9A%84%E7%94%9F%E6%88%90/"
                    data-tooltip="symfony源码分析之路由的生成"
                    aria-label="上一篇: symfony源码分析之路由的生成"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E6%A1%86%E6%9E%B6%E4%B8%BB%E6%B5%81%E7%A8%8B/"
                    data-tooltip="symfony源码分析之框架主流程"
                    aria-label="下一篇: symfony源码分析之框架主流程"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://fantiq.github.io/2017/06/29/symfony%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">fantiq</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                China HangZhou
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ffzlst6ssezilzbbgybxfwuegfobjsmomzthas0h8hymsrrzox2o6dre4owp.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
