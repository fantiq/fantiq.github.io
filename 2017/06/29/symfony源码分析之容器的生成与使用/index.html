
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="代码狗的狗窝">
    <title>symfony源码分析之容器的生成与使用 - 代码狗的狗窝</title>
    <meta name="author" content="fantiq">
    
    
    
    <meta name="description" content="symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\Component\HttpKernel\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var/cache/[ENV]/appProjectContainer中。">
<meta property="og:type" content="blog">
<meta property="og:title" content="symfony源码分析之容器的生成与使用">
<meta property="og:url" content="/2017/06/29/symfony源码分析之容器的生成与使用/index.html">
<meta property="og:site_name" content="代码狗的狗窝">
<meta property="og:description" content="symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\Component\HttpKernel\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var/cache/[ENV]/appProjectContainer中。">
<meta property="og:updated_time" content="2017-06-30T12:43:28.069Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="symfony源码分析之容器的生成与使用">
<meta name="twitter:description" content="symfony 的容器是有一个编译过程的，框架初始化的时候会执行 Symfony\Component\HttpKernel\Kernel::initializationContainer，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件var/cache/[ENV]/appProjectContainer中。">
    
    
        
    
    
        <meta property="og:image" content="/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ejlztp1tasruqfvoz6xmgqng0anzae8ox7cqjj5yibieqgcmhe9fwxfae6zj.min.css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">代码狗的狗窝</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg"/>
            </a>
            <span class="sidebar-profile-name">fantiq</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">搜索</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="https://github.com/fantiq"
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            symfony源码分析之容器的生成与使用
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Thu Jun 29 2017 20:50:36 GMT+0800">
	
		    6月 29, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/symfony源码分析/">symfony源码分析</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>symfony 的容器是有一个编译过程的，框架初始化的时候会执行 <code>Symfony\Component\HttpKernel\Kernel::initializationContainer</code>，这个方法会对代码进行检查，看是否需要生成新的容器代码。如果需要 Symfony 会将各个类的依赖关系通过编译生成静态的类并存储在缓存文件<code>var/cache/[ENV]/appProjectContainer</code>中。</p>
<p>其中很多是框架自己的依赖关系，这些依赖关系类似java的方式，通过xml文件的形式进行声明，这些xml存在与框架的代码中，<code>Syfmony\Bundle\FrameworkBundle\Resource\config\*.xml</code>。<br><a id="more"></a></p>
<h2 id="0-代码流程"><a href="#0-代码流程" class="headerlink" title="0. 代码流程"></a>0. 代码流程</h2><p>容器相关的代码大致如下流程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\HttpKernel\Kernel</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">initializeContainer</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 获取生成的容器代码文件 类名</span></span><br><span class="line">    $class = <span class="keyword">$this</span>-&gt;getContainerClass();</span><br><span class="line">    $cache = <span class="keyword">new</span> ConfigCache(<span class="keyword">$this</span>-&gt;getCacheDir().<span class="string">'/'</span>.$class.<span class="string">'.php'</span>, <span class="keyword">$this</span>-&gt;debug);</span><br><span class="line">    $fresh = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 检查是否需要重新生成 容器 缓存类</span></span><br><span class="line">    <span class="keyword">if</span> (!$cache-&gt;isFresh()) &#123;</span><br><span class="line">    	<span class="comment">// .....</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $container = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 重新生成容器缓存类</span></span><br><span class="line">            <span class="comment">// 实例化生成容器缓存代码的类</span></span><br><span class="line">            $container = <span class="keyword">$this</span>-&gt;buildContainer();</span><br><span class="line">            <span class="comment">// 调用方法开始生成容器代码</span></span><br><span class="line">            $container-&gt;compile();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        	<span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将生成的代码写入文件</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;dumpContainer($cache, $container, $class, <span class="keyword">$this</span>-&gt;getContainerBaseClass());</span><br><span class="line"></span><br><span class="line">        $fresh = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载生成的容器文件 实例化容器类 并且复制给 Kernel::$container</span></span><br><span class="line">    <span class="keyword">require_once</span> $cache-&gt;getPath();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;container = <span class="keyword">new</span> $class();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;container-&gt;set(<span class="string">'kernel'</span>, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面着重分析 容器代码生成类的创建过程<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildContainer</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 创建容器缓存代码的目录</span></span><br><span class="line"></span><br><span class="line">    $container = <span class="keyword">$this</span>-&gt;getContainerBuilder();</span><br><span class="line">    $container-&gt;addObjectResource(<span class="keyword">$this</span>);</span><br><span class="line">    <span class="comment">// 容器预处理，在开始编译容器前，会给容器添加一些 pass (这个问题就是在2017phpcon大会上提过的，当时没解决，这里看代码解决了)</span></span><br><span class="line">    <span class="comment">// 这些pass主要处理框架配置中声明的容器关系</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;prepareContainer($container);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析容器配置文件 我们自己注入容器的类就要声明在配置文件 app/config/services.yml 中</span></span><br><span class="line">    <span class="comment">// 这里就是对这个配置文件进行解析，并将其中的关系生成代码到容器中</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== $cont = <span class="keyword">$this</span>-&gt;registerContainerConfiguration(<span class="keyword">$this</span>-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">        $container-&gt;merge($cont);</span><br><span class="line">    &#125;</span><br><span class="line">    $container-&gt;addCompilerPass(<span class="keyword">new</span> AddAnnotatedClassesToCachePass(<span class="keyword">$this</span>));</span><br><span class="line">    $container-&gt;addResource(<span class="keyword">new</span> EnvParametersResource(<span class="string">'SYMFONY__'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如上的分析可以将容器代码生成的过程精简到如下3个步骤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\HttpKernel\Kernel</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">initializeContainer</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $container = <span class="keyword">null</span>;</span><br><span class="line">        $container = <span class="keyword">$this</span>-&gt;buildContainer();</span><br><span class="line">        <span class="number">3.</span> 编译生成容器代码</span><br><span class="line">        $container-&gt;compile();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildContainer</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 1. 实例化创建容器代码类的时候，预处理一些内容</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;prepareContainer($container);</span><br><span class="line">    <span class="comment">// 2. 加载项目容器的配置文件进行处理 app/config/services.yml</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== $cont = <span class="keyword">$this</span>-&gt;registerContainerConfiguration(<span class="keyword">$this</span>-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">        $container-&gt;merge($cont);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-容器预处理"><a href="#1-容器预处理" class="headerlink" title="1. 容器预处理"></a>1. 容器预处理</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\HttpKernel\Kernel</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareContainer</span><span class="params">(ContainerBuilder $container)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $extensions = <span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">// 这里的 bundles 是在 initializeBundles 方法中实例化AppKernel中注册的Bundles 进行的赋值</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bundles <span class="keyword">as</span> $bundle) &#123;</span><br><span class="line">    	<span class="comment">// 这里将注册的Bundle进行循环处理</span></span><br><span class="line">    	<span class="comment">// 取出bundle的extension 并 注册到 container中</span></span><br><span class="line">        <span class="keyword">if</span> ($extension = $bundle-&gt;getContainerExtension()) &#123;</span><br><span class="line">            $container-&gt;registerExtension($extension);</span><br><span class="line">            $extensions[] = $extension-&gt;getAlias();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;debug) &#123;</span><br><span class="line">            $container-&gt;addObjectResource($bundle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;bundles <span class="keyword">as</span> $bundle) &#123;</span><br><span class="line">    	<span class="comment">// 触发bundle的build方法</span></span><br><span class="line">        $bundle-&gt;build($container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;build($container);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的代码是为了确定将 MergeExtensionConfigurationPass 这个Pass类添加到容器的Pass中</span></span><br><span class="line">    $container-&gt;getCompilerPassConfig()-&gt;setMergePass(<span class="keyword">new</span> MergeExtensionConfigurationPass($extensions));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在 <code>AppKernel::registerBundles</code> 中查看到注册的 Bundles </p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function registerBundles()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="formula">$bundles = [</span><br><span class="line">        new Symfony<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">FrameworkBundle</span></span><span class="tag">\<span class="name">FrameworkBundle</span></span>(),</span><br><span class="line">        new Symfony<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">SecurityBundle</span></span><span class="tag">\<span class="name">SecurityBundle</span></span>(),</span><br><span class="line">        new Symfony<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">TwigBundle</span></span><span class="tag">\<span class="name">TwigBundle</span></span>(),</span><br><span class="line">        new Symfony<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">MonologBundle</span></span><span class="tag">\<span class="name">MonologBundle</span></span>(),</span><br><span class="line">        new Symfony<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">SwiftmailerBundle</span></span><span class="tag">\<span class="name">SwiftmailerBundle</span></span>(),</span><br><span class="line">        new Doctrine<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">DoctrineBundle</span></span><span class="tag">\<span class="name">DoctrineBundle</span></span>(),</span><br><span class="line">        new Sensio<span class="tag">\<span class="name">Bundle</span></span><span class="tag">\<span class="name">FrameworkExtraBundle</span></span><span class="tag">\<span class="name">SensioFrameworkExtraBundle</span></span>(),</span><br><span class="line">        new AppBundle<span class="tag">\<span class="name">AppBundle</span></span>(),</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    return $</span>bundles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以 <code>Symfony\Bundle\FrameworkBundle\FrameworkBundle</code> 作为目标进行代码的继续跟踪<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$extension</span> = <span class="variable">$bundle</span>-&gt;getContainerExtension();</span><br><span class="line"><span class="variable">$container</span>-&gt;registerExtension(<span class="variable">$extension</span>);</span><br></pre></td></tr></table></figure></p>
<p>跟中方法 <code>getContainerExtension</code> , 在类 <code>FrameworkBundle</code> 所继承的类<code>Syfmony\Component\HttpKernel\Bundle\Bundle</code>中找到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Syfmony\Component\HttpKernel\Bundle\Bundle</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContainerExtension</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;extension) &#123;</span><br><span class="line">    	<span class="comment">// 获取extension</span></span><br><span class="line">        $extension = <span class="keyword">$this</span>-&gt;createContainerExtension();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> !== $extension) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check naming convention</span></span><br><span class="line">            $basename = preg_replace(<span class="string">'/Bundle$/'</span>, <span class="string">''</span>, <span class="keyword">$this</span>-&gt;getName());</span><br><span class="line">            $expectedAlias = Container::underscore($basename);</span><br><span class="line">            <span class="keyword">if</span> ($expectedAlias != $extension-&gt;getAlias()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \LogicException(......);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;extension = $extension;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;extension = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;extension) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;extension;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是获取extension的代码逻辑<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainerExtension</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 这里实例化一个类并返回</span></span><br><span class="line">    <span class="keyword">if</span> (class_exists($class = <span class="keyword">$this</span>-&gt;getContainerExtensionClass())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> $class();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getContainerExtensionClass</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 类名的规则</span></span><br><span class="line">	<span class="comment">// 命名空间\DependencyInjection\(将类名的Bundle替换成Extension)</span></span><br><span class="line">    $basename = preg_replace(<span class="string">'/Bundle$/'</span>, <span class="string">''</span>, <span class="keyword">$this</span>-&gt;getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getNamespace().<span class="string">'\\DependencyInjection\\'</span>.$basename.<span class="string">'Extension'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下两个方法主要还是当 $this-&gt;namespace $this-&gt;name 不存在的时候</span></span><br><span class="line"><span class="comment"># 通过方法 $this-&gt;parseClassName() 来解析出来</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNamespace</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;namespace) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseClassName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;namespace;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;name) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseClassName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseClassName</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment"># 命名空间 类型的截取</span></span><br><span class="line">    $pos = strrpos(<span class="keyword">static</span>::class, <span class="string">'\\'</span>);</span><br><span class="line">	<span class="comment">// 截取类的命名空间</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;namespace = <span class="keyword">false</span> === $pos ? <span class="string">''</span> : substr(<span class="keyword">static</span>::class, <span class="number">0</span>, $pos);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;name) &#123;</span><br><span class="line">		<span class="comment">// 截取类的名称</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="keyword">false</span> === $pos ? <span class="keyword">static</span>::class : substr(<span class="keyword">static</span>::class, $pos + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码解析出来的就是 <code>Symfony\Bundle\FrameworkBundle\DependencyInjection\FrameworkExtension</code>。回到代码中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($extension = $bundle-&gt;getContainerExtension()) &#123;</span><br><span class="line">    $container-&gt;registerExtension($extension);</span><br><span class="line">    $extensions[] = $extension-&gt;getAlias();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>要执行容器的<code>registerExtension</code>方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\DependencyInjection\ContainerBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerExtension</span><span class="params">(ExtensionInterface $extension)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// $extension-&gt;getAlias() 这个方法在 Symfony\Component\DependencyInjection\Extension\Extension 中</span></span><br><span class="line">	<span class="comment">// 主要的作用是将类名取出 将类名的Excention后缀去掉</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;extensions[$extension-&gt;getAlias()] = $extension;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> !== $extension-&gt;getNamespace()) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;extensionsByNs[$extension-&gt;getNamespace()] = $extension;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-解析容器配置文件"><a href="#2-解析容器配置文件" class="headerlink" title="2. 解析容器配置文件"></a>2. 解析容器配置文件</h2><p>解析容器配置文件的代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> !== $cont = <span class="keyword">$this</span>-&gt;registerContainerConfiguration(<span class="keyword">$this</span>-&gt;getContainerLoader($container))) &#123;</span><br><span class="line">    $container-&gt;merge($cont);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要是执行了方法 <code>registerContainerConfiguration</code> 这个方法在 <code>AppKernel</code> 类中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AppKernel</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerContainerConfiguration</span><span class="params">(LoaderInterface $loader)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 这里的配置文件是 app/config/config_[ENV].yml 是Yml格式的文件</span></span><br><span class="line">	<span class="comment">// 这里的loader 应该是类 `YamlFileLoader`</span></span><br><span class="line">    $loader-&gt;load(<span class="keyword">$this</span>-&gt;getRootDir().<span class="string">'/config/config_'</span>.<span class="keyword">$this</span>-&gt;getEnvironment().<span class="string">'.yml'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所以这里的代码应该是执行 </span></span><br><span class="line"><span class="comment"># SymfonyComponent\DependencyInjection\Loader\YamlFileLoader::load</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($resource, $type = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 加载配置文件，将yml格式的配置内容解析成php数组</span></span><br><span class="line">    $content = <span class="keyword">$this</span>-&gt;loadFile($path);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;container-&gt;fileExists($path);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// 处理配置文件中的 key `imports`  对import 声明的文件进行load处理</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;parseImports($content, $path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理配置文件中的参数部分</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($content[<span class="string">'parameters'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_array($content[<span class="string">'parameters'</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(sprintf(<span class="string">'The "parameters" key should contain an array in %s. Check your YAML syntax.'</span>, $resource));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($content[<span class="string">'parameters'</span>] <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;container-&gt;setParameter($key, <span class="keyword">$this</span>-&gt;resolveServices($value, $resource, <span class="keyword">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// extensions</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadFromExtensions($content);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// services</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;anonymousServicesCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setCurrentDir(dirname($path));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// 这里将services中的声明封装到Definition 将Definition 存储到Container中</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseDefinitions($content, $resource);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instanceof = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseDefinitions</span><span class="params">(array $content, $file)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 如果配置文件中不存在key services 这里直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($content[<span class="string">'services'</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// 这里处理 配置文件中 services 下的 _default 配置信息，处理后会删除这个key</span></span><br><span class="line">    $defaults = <span class="keyword">$this</span>-&gt;parseDefaults($content, $file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对配置文件中定义的services进行逐个分析</span></span><br><span class="line">    <span class="keyword">foreach</span> ($content[<span class="string">'services'</span>] <span class="keyword">as</span> $id =&gt; $service) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseDefinition($id, $service, $file, $defaults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseDefinition</span><span class="params">($id, $service, $file, array $defaults)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化 definition</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isLoadingInstanceof) &#123;</span><br><span class="line">        $definition = <span class="keyword">new</span> ChildDefinition(<span class="string">''</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($service[<span class="string">'parent'</span>])) &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">        $definition = <span class="keyword">new</span> ChildDefinition($service[<span class="string">'parent'</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $definition = <span class="keyword">new</span> Definition();</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的大段逻辑是处理一些services相关的配置信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($service[<span class="string">'class'</span>])) &#123;</span><br><span class="line">        $definition-&gt;setClass($service[<span class="string">'class'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="string">'resource'</span>, $service)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_string($service[<span class="string">'resource'</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(sprintf(<span class="string">'A "resource" attribute must be of type string for service "%s" in %s. Check your YAML syntax.'</span>, $id, $file));</span><br><span class="line">        &#125;</span><br><span class="line">        $exclude = <span class="keyword">isset</span>($service[<span class="string">'exclude'</span>]) ? $service[<span class="string">'exclude'</span>] : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 如果service的配置中存在key resource 进行类的注册</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerClasses($definition, $id, $service[<span class="string">'resource'</span>], $exclude);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setDefinition($id, $definition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Symfony\Component\DependencyInjection\Loader\FileLoader</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerClasses</span><span class="params">(Definition $prototype, $namespace, $resource, $exclude = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// 一些判断</span></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里主要是处理 存在 resource 这个key的services注册</span></span><br><span class="line">	<span class="comment">// symfony的容器会将指定目录下都所有类都会注册到container</span></span><br><span class="line">	<span class="comment">// 这里的 findClasses 就是查询类的过程</span></span><br><span class="line">    $classes = <span class="keyword">$this</span>-&gt;findClasses($namespace, $resource, $exclude);</span><br><span class="line">    <span class="comment">// prepare for deep cloning</span></span><br><span class="line">    $prototype = serialize($prototype);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">    	<span class="comment">// 这里调用 setDefinition 对resource下的类全部设置到 container中</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setDefinition($class, unserialize($prototype));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setDefinition</span><span class="params">($id, Definition $definition)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// ...... </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将definition添加到 container 里面</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;container-&gt;setDefinition($id, $definition <span class="keyword">instanceof</span> ChildDefinition ? $definition : $definition-&gt;setInstanceofConditionals(<span class="keyword">$this</span>-&gt;instanceof));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里着重分析下 registerClasses方法中的 <code>$this-&gt;findClasses</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\DependencyInjection\Loader\FileLoader</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">findClasses</span><span class="params">($namespace, $pattern, $excludePattern)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// 这里是对文件的处理</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;glob($pattern, <span class="keyword">true</span>, $resource) <span class="keyword">as</span> $path =&gt; $info) &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">if</span> (!$r-&gt;isInterface() &amp;&amp; !$r-&gt;isTrait() &amp;&amp; !$r-&gt;isAbstract()) &#123;</span><br><span class="line">            $classes[] = $class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $classes;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Symfony\Component\Config\Loader\FileLoader</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">glob</span><span class="params">($pattern, $recursive, &amp;$resource = null, $ignoreErrors = false)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $prefix = <span class="keyword">$this</span>-&gt;locator-&gt;locate($prefix, <span class="keyword">$this</span>-&gt;currentDir, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileLocatorFileNotFoundException $e) &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里返回的是 yield</span></span><br><span class="line">    $resource = <span class="keyword">new</span> GlobResource($prefix, $pattern, $recursive);</span><br><span class="line">    <span class="comment">// 所以这里需要foreach来触发</span></span><br><span class="line">    <span class="keyword">foreach</span> ($resource <span class="keyword">as</span> $path =&gt; $info) &#123;</span><br><span class="line">        <span class="keyword">yield</span> $path =&gt; $info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Symfony\Component\Config\Resource\GlobResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === strpos(<span class="keyword">$this</span>-&gt;pattern, <span class="string">'/**/'</span>) &amp;&amp; (defined(<span class="string">'GLOB_BRACE'</span>) || <span class="keyword">false</span> === strpos(<span class="keyword">$this</span>-&gt;pattern, <span class="string">'&#123;'</span>))) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (glob(<span class="keyword">$this</span>-&gt;prefix.<span class="keyword">$this</span>-&gt;pattern, defined(<span class="string">'GLOB_BRACE'</span>) ? GLOB_BRACE : <span class="number">0</span>) <span class="keyword">as</span> $path) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;recursive &amp;&amp; is_dir($path)) &#123;</span><br><span class="line">            	<span class="comment">// 这里是读取文件的主要逻辑</span></span><br><span class="line">            	<span class="comment">// 使用的是 php 中提供的处理文件的迭代器</span></span><br><span class="line">                $files = iterator_to_array(<span class="keyword">new</span> \RecursiveIteratorIterator(</span><br><span class="line">                    <span class="keyword">new</span> \RecursiveCallbackFilterIterator(</span><br><span class="line">                        <span class="keyword">new</span> \RecursiveDirectoryIterator($path, \FilesystemIterator::SKIP_DOTS | \FilesystemIterator::FOLLOW_SYMLINKS),</span><br><span class="line">                        <span class="function"><span class="keyword">function</span> <span class="params">(\SplFileInfo $file)</span> </span>&#123; <span class="keyword">return</span> <span class="string">'.'</span> !== $file-&gt;getBasename()[<span class="number">0</span>]; &#125;</span><br><span class="line">                    ),</span><br><span class="line">                    \RecursiveIteratorIterator::LEAVES_ONLY</span><br><span class="line">                ));</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_file($path)) &#123;</span><br><span class="line">                <span class="keyword">yield</span> $path =&gt; <span class="keyword">new</span> \SplFileInfo($path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $finder = <span class="keyword">new</span> Finder();</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">foreach</span> ($finder-&gt;followLinks()-&gt;sortByName()-&gt;in(<span class="keyword">$this</span>-&gt;prefix) <span class="keyword">as</span> $path =&gt; $info) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match($regex, substr($path, $prefixLen)) &amp;&amp; $info-&gt;isFile()) &#123;</span><br><span class="line">            <span class="keyword">yield</span> $path =&gt; $info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-编译生成容器代码"><a href="#3-编译生成容器代码" class="headerlink" title="3. 编译生成容器代码"></a>3. 编译生成容器代码</h2><p>这段代码主要是执行 Pass代码 这里主要跟踪下 <code>MergeExtensionConfigurationPass</code> 这个Pass，他执行了 <code>FrameworkExtension::load</code> ，这个方法中加载了框架需要的各种类以及依赖关系</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Symfony\Component\DependencyInjection\Complier\Complier</span></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">(ContainerBuilder $container)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// 这里触发了所有Passs的 process方法</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;passConfig-&gt;getPasses() <span class="keyword">as</span> $pass) &#123;</span><br><span class="line">            $pass-&gt;process($container);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Symfony\Component\HttpKernel\DependencyInjection\MergeExtensionConfigurationPass</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(ContainerBuilder $container)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">parent</span>::process($container);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Symfony\Component\DependencyInjection\Compiler\MergeExtensionConfigurationPass</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(ContainerBuilder $container)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($container-&gt;getExtensions() <span class="keyword">as</span> $name =&gt; $extension) &#123;</span><br><span class="line">    	<span class="comment">// ......</span></span><br><span class="line">    	<span class="comment">// 执行了 extension 的 load 方法</span></span><br><span class="line">        $extension-&gt;load($config, $tmpContainer);</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $container-&gt;addDefinitions($definitions);</span><br><span class="line">    $container-&gt;addAliases($aliases);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Symfony\Bundle\FrameworkBundle\DependencyInjection\FrameworkExtension</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(array $configs, ContainerBuilder $container)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	这个方法中的代码很多，主要内容是加载了很多的 xml 配置文件 </span><br><span class="line">	这些配置文件的作用是声明框架所需要的类之间的关系</span><br><span class="line"></span><br><span class="line">	 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/php框架/">php框架</a> <a class="tag tag--primary tag--small t-link" href="/tags/symfony/">symfony</a> <a class="tag tag--primary tag--small t-link" href="/tags/源码分析/">源码分析</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/29/symfony源码分析之路由的生成/"  data-tooltip="symfony源码分析之路由的生成">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/29/symfony源码分析之框架主流程/" data-tooltip="symfony源码分析之框架主流程">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="ds-thread" class="ds-thread" data-thread-key="2017/06/29/symfony源码分析之容器的生成与使用/"
     data-title="symfony源码分析之容器的生成与使用" data-url="/2017/06/29/symfony源码分析之容器的生成与使用/">
</div>

            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 fantiq. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/29/symfony源码分析之路由的生成/"  data-tooltip="symfony源码分析之路由的生成">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/29/symfony源码分析之框架主流程/" data-tooltip="symfony源码分析之框架主流程">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-google-plus"></i><span class="">分享到 Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=/2017/06/29/symfony源码分析之容器的生成与使用/">
                <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg"/>
        
            <h4 id="about-card-name">fantiq</h4>
        
            <h5 id="about-card-bio"><p> good at develop framework </p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>developer</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                China
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-gfmrkxcl0qohe3cfdgxhzvc0yrceqta8i4iix0txvn8q4o2adlqd5n0jmkvt.min.js"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            var duoshuoQuery = {short_name:'fantiq'};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
    



</html>
